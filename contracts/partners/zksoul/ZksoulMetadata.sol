// SPDX-License-Identifier: GPL-3.0-or-later
pragma solidity ^0.8.4;

import "base64-sol/base64.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

/// @title Domain metadata contract
/// @author Tempe Techie
/// @notice Contract that stores metadata for a TLD
contract ZksoulMetadata is Ownable {
  string public description = "zkSoul is a soulbound identity used on zkChat.net - the first Web3 Social network on zkSync.";
  string public brand = "zkChat.net";

  // EVENTS
  event DescriptionChanged(address indexed user, string description);
  event BrandChanged(address indexed user, string brand);

  // READ
  function getMetadata(string calldata _domainName, string calldata _tld, uint256 _tokenId) public view returns(string memory) {
    string memory fullDomainName = string(abi.encodePacked(_domainName, _tld));

    return string(
      abi.encodePacked("data:application/json;base64,", Base64.encode(bytes(abi.encodePacked(
        '{"name": "', fullDomainName, '", ',
        '"description": "', description, '", ',
        '"image": "', _getImage(fullDomainName), '"}'))))
    );
  }

  function _getImage(string memory _fullDomainName) internal view returns (string memory) {
    string memory svgBase64Encoded = Base64.encode(bytes(string(abi.encodePacked(
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500" width="500" height="500" xmlns:xlink="http://www.w3.org/1999/xlink">',
        '<defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#000000;stop-opacity:1" /><stop offset="100%" style="stop-color:#8C42D1;stop-opacity:1" /></linearGradient><clipPath id="A"><path d="M0 0h149.801v149.801H0zm0 0" clip-rule="nonzero"/></clipPath><path id="B" d="M61.902 56.608c0-1.43.484-2.637 1.453-3.625.961-.98 2.152-1.469 3.578-1.469s2.625.488 3.594 1.469c.961.988 1.438 2.195 1.438 3.625 0 1.383-.477 2.57-1.437 3.563-.969.988-2.164 1.484-3.594 1.484s-2.617-.496-3.578-1.484c-.969-.992-1.453-2.18-1.453-3.562zm0 0"/></defs>',
        '<rect x="0" y="0" width="500" height="500" fill="url(#grad)"/>',
        '<g transform="scale(0.85 0.85) translate(218, 125)"><g clip-path="url(#A)"><path fill="#fff" d="M53.5 5.352a5.49 5.49 0 0 1-.102 1.043c-.07.344-.172.68-.305 1.004a5.55 5.55 0 0 1-.496.926 5.71 5.71 0 0 1-.664.809 5.29 5.29 0 0 1-.812.664 5.11 5.11 0 0 1-.922.496c-.328.133-.66.234-1.004.305a5.56 5.56 0 0 1-1.047.102H16.051a5.19 5.19 0 0 0-1.043.105 5.22 5.22 0 0 0-1.004.301 5.55 5.55 0 0 0-.926.496 5.53 5.53 0 0 0-.812.664 5.53 5.53 0 0 0-.664.813 5.55 5.55 0 0 0-.496.926 5.22 5.22 0 0 0-.301 1.004 5.19 5.19 0 0 0-.105 1.043v32.098a5.56 5.56 0 0 1-.102 1.047c-.07.344-.172.676-.305 1.004a5.11 5.11 0 0 1-.496.922 5.29 5.29 0 0 1-.664.813 5.71 5.71 0 0 1-.809.664 5.55 5.55 0 0 1-.926.496c-.324.133-.66.234-1.004.305a5.49 5.49 0 0 1-1.043.102 5.56 5.56 0 0 1-1.047-.102c-.344-.07-.676-.172-1.004-.305s-.633-.301-.922-.496a5.53 5.53 0 0 1-.813-.664 5.53 5.53 0 0 1-.664-.812c-.195-.289-.359-.598-.496-.922s-.234-.66-.305-1.004A5.56 5.56 0 0 1 0 48.148V16.051c0-.527.027-1.051.078-1.574s.129-1.043.23-1.559a15.87 15.87 0 0 1 .383-1.527l.531-1.484a16.26 16.26 0 0 1 .672-1.422l.809-1.352.941-1.266a16.54 16.54 0 0 1 1.055-1.168l1.168-1.055a15.62 15.62 0 0 1 1.266-.941l1.352-.809 1.422-.672a15.62 15.62 0 0 1 1.484-.531l1.527-.383 1.559-.23L16.051 0h32.098a5.56 5.56 0 0 1 1.047.102c.344.07.676.172 1.004.305s.633.301.922.496a5.53 5.53 0 0 1 .813.664 5.53 5.53 0 0 1 .664.813c.195.289.359.598.496.922s.234.66.305 1.004a5.56 5.56 0 0 1 .102 1.047zM133.75 0h-32.102a5.49 5.49 0 0 0-1.043.102c-.344.07-.68.172-1.004.305a5.55 5.55 0 0 0-.926.496 5.71 5.71 0 0 0-.809.664 5.29 5.29 0 0 0-.664.813 5.11 5.11 0 0 0-.496.922c-.133.328-.234.66-.305 1.004a5.56 5.56 0 0 0-.102 1.047 5.49 5.49 0 0 0 .102 1.043c.07.344.172.68.305 1.004s.301.633.496.926.414.559.664.809.52.469.809.664.602.363.926.496.66.234 1.004.305a5.49 5.49 0 0 0 1.043.102h32.102a5.19 5.19 0 0 1 1.043.105 5.3 5.3 0 0 1 1.004.301 5.55 5.55 0 0 1 .926.496 5.3 5.3 0 0 1 .809.664c.25.25.473.52.668.813a5.26 5.26 0 0 1 .492.926c.137.324.238.656.305 1.004a5.19 5.19 0 0 1 .105 1.043v32.098c0 .352.031.699.102 1.047a5.12 5.12 0 0 0 .305 1.004 5.09 5.09 0 0 0 .492.922c.195.293.418.563.668.813a5.5 5.5 0 0 0 .809.664 5.55 5.55 0 0 0 .926.496c.324.133.66.234 1.004.305a5.49 5.49 0 0 0 1.043.102 5.49 5.49 0 0 0 1.043-.102 5.52 5.52 0 0 0 1.004-.305 5.55 5.55 0 0 0 .926-.496 5.53 5.53 0 0 0 1.477-1.477c.195-.289.359-.598.496-.922a5.39 5.39 0 0 0 .301-1.004 5.26 5.26 0 0 0 .105-1.047V16.051l-.078-1.574c-.051-.523-.129-1.043-.23-1.559a15.87 15.87 0 0 0-.383-1.527l-.531-1.484a16.26 16.26 0 0 0-.672-1.422l-.812-1.352c-.289-.437-.602-.859-.937-1.266a15.69 15.69 0 0 0-1.059-1.168l-1.164-1.055a15.62 15.62 0 0 0-1.266-.941l-1.352-.809-1.426-.672a15.55 15.55 0 0 0-1.48-.531l-1.527-.383-1.559-.23L133.75 0zM48.148 139.102H16.051a5.19 5.19 0 0 1-1.043-.105c-.348-.066-.68-.168-1.004-.305a5.26 5.26 0 0 1-.926-.492c-.293-.195-.562-.418-.812-.668a5.3 5.3 0 0 1-.664-.809 5.55 5.55 0 0 1-.496-.926 5.3 5.3 0 0 1-.301-1.004 5.19 5.19 0 0 1-.105-1.043v-32.102a5.49 5.49 0 0 0-.102-1.043c-.07-.344-.172-.68-.305-1.004s-.301-.633-.496-.926-.414-.559-.664-.809-.52-.469-.809-.664-.602-.363-.926-.496-.66-.234-1.004-.305a5.49 5.49 0 0 0-1.043-.102 5.56 5.56 0 0 0-1.047.102c-.344.07-.676.172-1.004.305a5.11 5.11 0 0 0-.922.496 5.29 5.29 0 0 0-.813.664 5.71 5.71 0 0 0-.664.809 5.55 5.55 0 0 0-.496.926c-.133.324-.234.66-.305 1.004A5.49 5.49 0 0 0 0 101.648v32.102c0 .527.027 1.051.078 1.574s.129 1.043.23 1.559a15.87 15.87 0 0 0 .383 1.527l.531 1.48c.199.488.426.961.672 1.426l.809 1.352.941 1.266a15.66 15.66 0 0 0 1.055 1.164l1.168 1.059c.406.336.828.648 1.266.938l1.352.813 1.422.672a15.62 15.62 0 0 0 1.484.531l1.527.383 1.559.23 1.574.078h32.098a5.26 5.26 0 0 0 1.047-.105 5.39 5.39 0 0 0 1.004-.301c.324-.137.633-.301.922-.496a5.53 5.53 0 0 0 1.477-1.477 5.55 5.55 0 0 0 .496-.926 5.52 5.52 0 0 0 .305-1.004 5.49 5.49 0 0 0 .102-1.043 5.49 5.49 0 0 0-.102-1.043c-.07-.344-.172-.68-.305-1.004a5.55 5.55 0 0 0-.496-.926 5.5 5.5 0 0 0-.664-.809c-.25-.25-.52-.473-.812-.668a5.09 5.09 0 0 0-.922-.492 5.12 5.12 0 0 0-1.004-.305c-.348-.07-.695-.102-1.047-.102zm96.301-42.801a5.49 5.49 0 0 0-1.043.102c-.344.07-.68.172-1.004.305s-.633.301-.926.496a5.26 5.26 0 0 0-.809.664 5.48 5.48 0 0 0-.668.809 5.26 5.26 0 0 0-.492.926c-.137.324-.238.66-.305 1.004s-.102.691-.102 1.043v32.102a5.19 5.19 0 0 1-.105 1.043c-.066.344-.168.68-.305 1.004a5.26 5.26 0 0 1-.492.926c-.195.293-.418.563-.668.809s-.516.473-.809.668a5.26 5.26 0 0 1-.926.492c-.324.137-.66.238-1.004.305a5.19 5.19 0 0 1-1.043.105H107c-.352 0-.699.031-1.043.102s-.68.168-1.004.305a5.26 5.26 0 0 0-.926.492c-.293.195-.562.418-.809.668s-.473.52-.668.809a5.26 5.26 0 0 0-.492.926c-.137.324-.238.66-.305 1.004a5.19 5.19 0 0 0 0 2.086c.066.348.168.68.305 1.004a5.26 5.26 0 0 0 .492.926c.195.293.418.563.668.813a5.3 5.3 0 0 0 .809.664 5.55 5.55 0 0 0 .926.496 5.3 5.3 0 0 0 1.004.301 5.19 5.19 0 0 0 1.043.105h26.75c.527 0 1.051-.027 1.574-.078l1.559-.23a15.87 15.87 0 0 0 1.527-.383l1.48-.531c.488-.199.961-.426 1.426-.672l1.352-.812c.438-.289.859-.602 1.266-.937s.793-.684 1.164-1.059.727-.758 1.059-1.164.648-.828.938-1.266l.813-1.352.672-1.426a15.55 15.55 0 0 0 .531-1.48l.383-1.527.23-1.559.078-1.574v-32.102a5.19 5.19 0 0 0-.105-1.043 5.3 5.3 0 0 0-.301-1.004 5.55 5.55 0 0 0-.496-.926 5.71 5.71 0 0 0-.664-.809 5.29 5.29 0 0 0-.812-.664c-.293-.195-.602-.363-.926-.496a5.52 5.52 0 0 0-1.004-.305 5.49 5.49 0 0 0-1.043-.102zm0 0"/></g><g fill="#fff"><path d="M45.363 48.438c0-5.855 1.949-10.227 5.844-13.109 1.875-1.375 3.809-2.445 5.797-3.203s3.922-1.141 5.797-1.141h23.625c1.887 0 3.824.379 5.813 1.141 1.98.758 3.914 1.828 5.797 3.203a14.45 14.45 0 0 1 4.328 5.344c1.012 2.133 1.516 4.723 1.516 7.766v64.047c0 3.469-2.129 5.203-6.391 5.203-4.332 0-6.5-1.734-6.5-5.203V49.297c0-1.875-.539-3.574-1.625-5.094-1.082-1.512-2.961-2.266-5.641-2.266H65.519c-2.676 0-4.555.754-5.641 2.266a8.58 8.58 0 0 0-1.625 5.094v63.187c0 3.469-2.129 5.203-6.391 5.203-4.332 0-6.5-1.734-6.5-5.203zm0 0"/><use xlink:href="#B"/><use xlink:href="#B" x="15.369"/></g></g>',
        '<text x="50%" y="55%" dominant-baseline="middle" fill="white" text-anchor="middle" font-size="x-large" font-family="sans-serif">',
        _fullDomainName,'</text>',
        '<text x="50%" y="80%" dominant-baseline="middle" fill="white" text-anchor="middle" font-family="sans-serif">',
        brand,'</text>',
      '</svg>'
    ))));

    return string(abi.encodePacked("data:image/svg+xml;base64,", svgBase64Encoded));
  }

  // WRITE (OWNER)

  /// @notice Only metadata contract owner can call this function.
  function changeBrand(string calldata _brand) external onlyOwner {
    brand = _brand;
    emit BrandChanged(msg.sender, _brand);
  }

  /// @notice Only metadata contract owner can call this function.
  function changeDescription(string calldata _description) external onlyOwner {
    description = _description;
    emit DescriptionChanged(msg.sender, _description);
  }
}